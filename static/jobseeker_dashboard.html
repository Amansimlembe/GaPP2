<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Seeker Dashboard - GaPP2</title>
    <script src="https://mozilla.github.io/pdf.js/build/pdf.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f0f4f8; }
        .container { max-width: 1200px; margin: auto; display: grid; grid-template-columns: 1fr 2fr; gap: 20px; }
        .sidebar { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .main { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        h2, h3 { color: #333; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .job-card, .chat-card { padding: 15px; margin-bottom: 10px; background: #f9f9f9; border-radius: 5px; }
        .chat-area { height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; margin-bottom: 10px; }
        .message-input { display: flex; gap: 10px; }
        input[type="text"], input[type="file"] { padding: 10px; border: 1px solid #ddd; border-radius: 5px; flex-grow: 1; }
        video { width: 100%; max-width: 400px; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <h2>Job Seeker Dashboard</h2>
            <button onclick="logout()">Logout</button>
            <h3>Upload CV</h3>
            <input type="file" id="cvInput" accept=".pdf">
            <button onclick="uploadCV()">Upload & Enhance</button>
            <h3>Chat List</h3>
            <div id="chatList"></div>
            <h3>Groups</h3>
            <input type="text" id="groupName" placeholder="Group Name">
            <input type="text" id="groupMembers" placeholder="User IDs (comma-separated)">
            <button onclick="createGroup()">Create Group</button>
            <div id="groupList"></div>
        </div>
        <div class="main">
            <h3>Jobs</h3>
            <div id="jobList"></div>
            <h3>Chat</h3>
            <div id="messages" class="chat-area"></div>
            <div class="message-input">
                <input type="text" id="messageInput" placeholder="Type a message">
                <input type="file" id="mediaInput" accept="image/*,audio/*,video/*">
                <button onclick="sendMessage('text')">Send Text</button>
                <button onclick="sendMessage('media')">Send Media</button>
            </div>
            <h3>Video Call</h3>
            <video id="localVideo" autoplay muted></video>
            <video id="remoteVideo" autoplay></video>
            <button onclick="startVideoCall()">Start Call</button>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('token');
        const userId = parseInt(localStorage.getItem('userId'));
        let socket, peer, localStream;

        async function loadDashboard() {
            const jobsResp = await fetch('/jobs/ai_fetched', { headers: { 'Authorization': `Bearer ${token}` } });
            const aiJobs = await jobsResp.json();
            const employerJobsResp = await fetch('/jobseeker/dashboard', { headers: { 'Authorization': `Bearer ${token}` } });
            const employerJobs = (await employerJobsResp.json()).jobs;
            const allJobs = [...employerJobs, ...aiJobs];
            const jobSeeker = await (await fetch('/jobseeker/update_cv', { headers: { 'Authorization': `Bearer ${token}` } })).json();
            const skills = jobSeeker.skills || '';
            document.getElementById('jobList').innerHTML = allJobs
                .filter(job => job.requirements.includes(skills.split(',')[0]) || true) // Basic matching
                .map(job => `
                    <div class="job-card">
                        <h4>${job.title}</h4>
                        <p>${job.description}</p>
                        <button onclick="applyForJob(${job._id})">Apply</button>
                    </div>
                `).join('');

            socket = new WebSocket(`wss://${window.location.host}/ws/${userId}`);
            socket.onmessage = (event) => {
                const msg = JSON.parse(event.data);
                if (msg.type === 'webrtc_signal') handleSignal(msg);
                else appendMessage(msg);
            };

            loadChatList();
            loadGroups();
        }

        async function loadChatList() {
            const resp = await fetch('/chat_list', { headers: { 'Authorization': `Bearer ${token}` } });
            const chats = await resp.json();
            document.getElementById('chatList').innerHTML = chats.map(chat => `
                <div class="chat-card" onclick="loadMessages(${chat.user_id})">${chat.email || chat.company_name} (${chat.unread})</div>
            `).join('');
        }

        async function loadGroups() {
            const resp = await fetch('/groups', { headers: { 'Authorization': `Bearer ${token}` } });
            const groups = await resp.json();
            document.getElementById('groupList').innerHTML = groups.map(group => `
                <div class="chat-card" onclick="loadGroupMessages(${group._id})">${group.name}</div>
            `).join('');
        }

        async function loadMessages(recipientId) {
            localStorage.setItem('chatTarget', recipientId);
            const resp = await fetch(`/messages/${recipientId}`, { headers: { 'Authorization': `Bearer ${token}` } });
            const messages = await resp.json();
            document.getElementById('messages').innerHTML = messages.map(m => renderMessage(m)).join('');
        }

        async function loadGroupMessages(groupId) {
            localStorage.setItem('chatTarget', `group_${groupId}`);
            const resp = await fetch(`/messages/group/${groupId}`, { headers: { 'Authorization': `Bearer ${token}` } });
            const messages = await resp.json();
            document.getElementById('messages').innerHTML = messages.map(m => renderMessage(m)).join('');
        }

        function renderMessage(msg) {
            if (msg.message_type === 'text') return `<p>${msg.sender_id === userId ? 'You' : 'Them'}: ${msg.content}</p>`;
            if (msg.message_type === 'image') return `<p><img src="${msg.content}" style="max-width: 200px;"></p>`;
            if (msg.message_type === 'audio') return `<p><audio controls src="${msg.content}"></audio></p>`;
            if (msg.message_type === 'video') return `<p><video controls src="${msg.content}" style="max-width: 200px;"></video></p>`;
        }

        async function sendMessage(type) {
            const target = localStorage.getItem('chatTarget');
            if (!target) return alert('Select a chat first');
            if (type === 'text') {
                const content = document.getElementById('messageInput').value;
                socket.send(JSON.stringify({
                    recipient_id: target.startsWith('group_') ? null : parseInt(target),
                    group_id: target.startsWith('group_') ? parseInt(target.split('_')[1]) : null,
                    message_type: 'text',
                    content
                }));
                document.getElementById('messageInput').value = '';
            } else {
                const file = document.getElementById('mediaInput').files[0];
                const reader = new FileReader();
                reader.onload = () => {
                    socket.send(JSON.stringify({
                        recipient_id: target.startsWith('group_') ? null : parseInt(target),
                        group_id: target.startsWith('group_') ? parseInt(target.split('_')[1]) : null,
                        message_type: file.type.split('/')[0],
                        content: reader.result
                    }));
                };
                reader.readAsDataURL(file);
            }
        }

        function appendMessage(msg) {
            document.getElementById('messages').innerHTML += renderMessage(msg);
        }

        async function uploadCV() {
            const file = document.getElementById('cvInput').files[0];
            const formData = new FormData();
            formData.append('cv', file);
            const resp = await fetch('/jobseeker/update_cv', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` },
                body: formData
            });
            const data = await resp.json();
            alert(data.message);
        }

        async function applyForJob(jobId) {
            const resp = await fetch('/jobseeker/apply', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ job_id: jobId })
            });
            alert((await resp.json()).message);
        }

        async function createGroup() {
            const name = document.getElementById('groupName').value;
            const members = document.getElementById('groupMembers').value;
            const resp = await fetch('/groups/create', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/x-www-form-urlencoded' },
                body: new URLSearchParams({ name, members })
            });
            alert((await resp.json()).message);
            loadGroups();
        }

        async function startVideoCall() {
            const target = localStorage.getItem('chatTarget');
            if (!target || target.startsWith('group_')) return alert('Select a 1:1 chat');
            localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            document.getElementById('localVideo').srcObject = localStream;
            peer = new RTCPeerConnection();
            localStream.getTracks().forEach(track => peer.addTrack(track, localStream));
            peer.ontrack = (event) => document.getElementById('remoteVideo').srcObject = event.streams[0];
            peer.onicecandidate = (event) => {
                if (event.candidate) {
                    socket.send(JSON.stringify({ type: 'webrtc_signal', signal: event.candidate, to: target, room: `${userId}-${target}` }));
                }
            };
            const offer = await peer.createOffer();
            await peer.setLocalDescription(offer);
            socket.send(JSON.stringify({ type: 'webrtc_signal', signal: offer, to: target, room: `${userId}-${target}` }));
        }

        function handleSignal(msg) {
            if (msg.signal.type === 'offer') {
                peer = new RTCPeerConnection();
                localStream = navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                document.getElementById('localVideo').srcObject = localStream;
                localStream.getTracks().forEach(track => peer.addTrack(track, localStream));
                peer.ontrack = (event) => document.getElementById('remoteVideo').srcObject = event.streams[0];
                peer.onicecandidate = (event) => {
                    if (event.candidate) {
                        socket.send(JSON.stringify({ type: 'webrtc_signal', signal: event.candidate, to: msg.sender_id, room: msg.room }));
                    }
                };
                peer.setRemoteDescription(new RTCSessionDescription(msg.signal));
                const answer = peer.createAnswer();
                peer.setLocalDescription(answer);
                socket.send(JSON.stringify({ type: 'webrtc_signal', signal: answer, to: msg.sender_id, room: msg.room }));
            } else if (msg.signal.type === 'answer') {
                peer.setRemoteDescription(new RTCSessionDescription(msg.signal));
            } else {
                peer.addIceCandidate(new RTCIceCandidate(msg.signal));
            }
        }

        function logout() {
            localStorage.clear();
            window.location.href = '/';
        }

        window.onload = () => token ? loadDashboard() : window.location.href = '/';
    </script>
</body>
</html>